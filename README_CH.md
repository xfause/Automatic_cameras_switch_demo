# 基于光流与骨骼位置的相机自动切换系统

## 效果展示

![](https://s4.ax1x.com/2022/02/19/HbhGxs.gif)

## 原理

该系统适用于舞蹈视频的相机分镜自动切换，是基于光流和骨骼位置的运算，以Beat为节点（下称‘拍’）。
计算每拍结束时，与上一拍结束时的光流，用以表示动作的剧烈程度等多个不同维度的概率模型。

在多个预设好相对位置的相机中，选择计算出的概率最大的一个为当前相机。

## 模型计算规则

- 保证一定时间范围内的观感连续性
  - 为了保持在某一镜头的连续性，如果在当前镜头的持续拍数小于某一阈值，则下一拍仍然在该镜头的概率为1，反之如果超出某一阈值，则概率为-1，此外下一拍在某一镜头的概率为均匀分布。
  - 保证了不会出现频繁切换相机的效果
- 更倾向与在不同构图的镜头之间切换
  - 通过计算运动开始到当前拍的平均光流，在平均光流较大和平均光流较小的相机中以概率模型为基础切换，以此保证是不同构图。
- 增加距离主体远的相机被选中的概率
  - 通过全景体现舞蹈动作内容
  - 相机距离越近，在该镜头的持续时间越短，反之则越长。
- 设定一个主相机
  - 增加在该主相机的持续时间，以避免缺乏主体。
  - 使用骨骼位置，以角色模型在视频画面中的占比为主要参数
- 强调节奏，切换到动作相对更距离的相机
  - 计算平均光流及上一拍的光流，如果相差较大，说明该处节奏和运动更加激烈。

结合以上五条规则得到的概率模型，会给出一系列是否切换到该处的概率值，决定在当前拍应该切换到哪个相机，并赋予相应的切换特效。

## 问题

- 计算光流的效率问题
  - 官方有提供opencv for unity这一插件，但是因为费用原因，所以使用的是opencv plus unity这一免费插件，在计算光流的效率上可能存在问题。
  - 由于计算光流与分辨率关系较大，因此分辨率较高时卡顿更加严重。
- 概率模型并非完美
  - 或许有其他更多在舞蹈视频中需要遵守的原则
- 自动切换特效
  - 支持自动切换特效，但是选择何种特效的规则还相对简陋
  - 目前仅支持渐变，硬切，运动切换。
- 相机缩放比例问题
  - fov计算困难，虽然通过归一化尽量减少了不同fov下角色占屏幕比例不同导致的光流大小不同的问题，但是仍然存在误差。

## 注意

因为我在这个项目中使用的免费插件被作者警告“无法上传到 github”。

所以我把代码库打包在云端，你可以在这里下载

链接：https://pan.baidu.com/s/12iJGlMY30gpdPRjDeXR4kg

密码：7hfw
